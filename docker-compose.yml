# ===================================================================
# Docker Compose - Infrastructure Services
# Generated from docker/versions.toml
# Environment: development
# Generated: 2025-11-11 23:07:01 UTC
# ===================================================================

# Extension field for reusable shell command (YAML anchor)
# Entfernt potenzielle Newline-Zeichen aus dem Secret, um Auth-Fehler zu vermeiden
x-db_is_ready_cmd: &db_is_ready_cmd pg_isready -U "$(tr -d '\n' </run/secrets/postgres_user)" -d "${POSTGRES_DB:-meldestelle}"

services:
  # ===================================================================
  # Database
  # ===================================================================
  postgres:
    image: postgres:${DOCKER_POSTGRES_VERSION:-17-alpine}
    container_name: meldestelle-postgres
    user: "0:0"
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-meldestelle}
    # Wrapper: Secrets einlesen und als ENV setzen, bevor der offizielle Entrypoint startet
    entrypoint: ["/bin/sh", "-ec", "export POSTGRES_USER=\"$(tr -d '\\n' </run/secrets/postgres_user)\"; export POSTGRES_PASSWORD=\"$(tr -d '\\n' </run/secrets/postgres_password)\"; exec /usr/local/bin/docker-entrypoint.sh postgres"]
    # Wichtiger Fix: Statt Compose-Secrets (die auf manchen Hosts Rootless/UID-Remap zu Permission denied führen)
    # binden wir die Secret-Dateien explizit read-only ein. So kann der Wrapper sie zuverlässig lesen.
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/services/postgres:/docker-entrypoint-initdb.d
      - ./docker/secrets/postgres_user.txt:/run/secrets/postgres_user:ro
      - ./docker/secrets/postgres_password.txt:/run/secrets/postgres_password:ro
    networks:
      - meldestelle-network
    healthcheck:
      test: ["CMD-SHELL", *db_is_ready_cmd]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ===================================================================
  # Cache
  # ===================================================================
  redis:
    image: redis:${DOCKER_REDIS_VERSION:-8-alpine}
    container_name: meldestelle-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    entrypoint: ["/bin/sh", "-c"]
    command: |
      exec redis-server --appendonly yes --requirepass "$(cat /run/secrets/redis_password | tr -d '\n')"
    secrets:
      - redis_password
    networks:
      - meldestelle-network
    healthcheck:
      test: ["CMD-SHELL", "REDISCLI_AUTH=\"$(tr -d '\n' </run/secrets/redis_password)\" redis-cli ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ===================================================================
  # Service Discovery
  # ===================================================================
  consul:
    image: consul:${DOCKER_CONSUL_VERSION:-1.15}
    container_name: meldestelle-consul
    ports:
      - "8500:8500"
    command: agent -dev -client=0.0.0.0 -ui
    volumes:
      - consul-data:/consul/data
    networks:
      - meldestelle-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ===================================================================
  # Messaging
  # ===================================================================
  zookeeper:
    image: zookeeper:${DOCKER_ZOOKEEPER_VERSION:-3.9}
    container_name: meldestelle-zookeeper
    ports:
      - "2181:2181"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    volumes:
      - zookeeper-data:/bitnami/zookeeper
    networks:
      - meldestelle-network
    restart: unless-stopped

  kafka:
    image: apache/kafka:${DOCKER_KAFKA_VERSION:-4.1.0}
    container_name: meldestelle-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    depends_on:
      - zookeeper
    volumes:
      - kafka-data:/bitnami/kafka
    networks:
      - meldestelle-network
    restart: unless-stopped

  # ===================================================================
  # Authentication
  # ===================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:${DOCKER_KEYCLOAK_VERSION:-26.4}
    container_name: meldestelle-keycloak
    user: "0:0"
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-meldestelle}
    secrets:
      - kc_bootstrap_admin_username
      - kc_bootstrap_admin_password
      - postgres_user
      - postgres_password
    ports:
      - "8180:8080"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./docker/services/keycloak:/opt/keycloak/data/import
    # Wrapper: liest Docker Secrets und exportiert sie als Umgebungsvariablen
    # bevor Keycloak gestartet wird. Wir überschreiben den ENTRYPOINT auf /bin/sh,
    # da das offizielle Image standardmäßig kc.sh als ENTRYPOINT setzt.
    entrypoint: ["/bin/sh", "-c"]
    command: >

      # Admin-Credentials aus Secrets setzen
      export KEYCLOAK_ADMIN="$(cat /run/secrets/kc_bootstrap_admin_username | tr -d '\n')" &&
      export KEYCLOAK_ADMIN_PASSWORD="$(cat /run/secrets/kc_bootstrap_admin_password | tr -d '\n')" &&

      # DB-Credentials aus Secrets setzen
      export KC_DB_USERNAME=$(cat /run/secrets/postgres_user | tr -d '\n') &&
      export KC_DB_PASSWORD=$(cat /run/secrets/postgres_password | tr -d '\n') &&

      # Keycloak starten (dev) und Realm importieren
      exec /opt/keycloak/bin/kc.sh start-dev --import-realm
    networks:
      - meldestelle-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ===================================================================
  # Monitoring
  # ===================================================================
  prometheus:
    image: prom/prometheus:${DOCKER_PROMETHEUS_VERSION:-v3.7.0}
    container_name: meldestelle-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - prometheus-data:/prometheus
      - ./docker/monitoring/prometheus:/etc/prometheus:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    networks:
      - meldestelle-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  grafana:
    image: grafana/grafana:${DOCKER_GRAFANA_VERSION:-main-ubuntu}
    container_name: meldestelle-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: ${GF_USERS_ALLOW_SIGN_UP:-false}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/monitoring/grafana:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - meldestelle-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

# ===================================================================
# Secrets
# ===================================================================
secrets:
  kc_bootstrap_admin_username:
    file: ./docker/secrets/kc_bootstrap_admin_username.txt
  kc_bootstrap_admin_password:
    file: ./docker/secrets/kc_bootstrap_admin_password.txt
  postgres_user:
    file: ./docker/secrets/postgres_user.txt
  postgres_password:
    file: ./docker/secrets/postgres_password.txt
  redis_password:
    file: ./docker/secrets/redis_password.txt

# ===================================================================
# Volumes
# ===================================================================
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  consul-data:
    driver: local
  zookeeper-data:
    driver: local
  kafka-data:
    driver: local

# ===================================================================
# Networks
# ===================================================================
networks:
  meldestelle-network:
    driver: bridge
